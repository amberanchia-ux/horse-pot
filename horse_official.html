<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¸½éƒ¨å®˜ç¶²(æ‰‹å‹•è¼¸å…¥) - é¦¬å¹´å£ºæ¶è™Ÿç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 p-4 md:p-8">
  <div class="max-w-6xl mx-auto">
    <div class="mb-6">
      <h1 class="text-2xl md:text-3xl font-black text-slate-800">ç¸½éƒ¨å®˜ç¶²(æ‰‹å‹•è¼¸å…¥)</h1>
      <p class="text-sm text-slate-500 font-bold mt-1">è«‹å”åŠ©å®˜ç¶²è¨‚å–®æˆ–é›»è©±è¨‚å–®é€²è¡Œå³æ™‚é–å®š</p>
    </div>

    <div class="flex gap-4 mb-6 text-sm font-bold">
      <div class="flex items-center"><div class="w-4 h-4 bg-green-100 border-2 border-green-500 rounded mr-1"></div>å¯é¸</div>
      <div class="flex items-center"><div class="w-4 h-4 bg-yellow-100 border-2 border-yellow-400 rounded mr-1"></div>é–å®šä¸­</div>
      <div class="flex items-center"><div class="w-4 h-4 bg-red-100 border-2 border-red-400 rounded mr-1"></div>å·²å”®å‡º</div>
    </div>

    <div id="grid" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-3">
      </div>
  </div>

  <script type="module">
    // å°å…¥ Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, collection, doc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCTHXe0izz5FYcKZf3m_WBV2nBnbREgOjA",
      authDomain: "horse-pot-lock.firebaseapp.com",
      projectId: "horse-pot-lock",
      messagingSenderId: "211854672738",
      appId: "1:211854672738:web:581c17af995d31d4ebe23b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // ğŸ”´ é€™è£¡è¨­å®šé€™å€‹ç¶²é çš„èº«ä»½ï¼Œè³‡æ–™åº«æœƒç›´æ¥èªé€™å€‹åå­—
    const STORE_NAME = "ç¸½éƒ¨å®˜ç¶²"; 
    const COLLECTION_NAME = "limited_numbers";

    const gridEl = document.getElementById("grid");
    let numbers = {};

    // æ¸²æŸ“ç•«é¢
    function render() {
      gridEl.innerHTML = "";
      // æ’åº 1-168
      const sorted = Object.values(numbers).sort((a, b) => a.number - b.number);

      sorted.forEach(item => {
        const el = document.createElement("div");
        // æ¨£å¼é‚è¼¯
        let baseClass = "p-2 rounded-xl border-2 flex flex-col justify-between transition-all min-h-[80px]";
        let statusClass = "bg-white border-slate-200";
        let btnHtml = "";

        if (item.status === "available") {
          statusClass = "bg-green-50 border-green-200 hover:border-green-400 shadow-sm cursor-pointer";
          btnHtml = `<button onclick="window.lock(${item.number})" class="w-full py-1 bg-green-500 text-white rounded font-bold text-xs mt-1">é–å®š</button>`;
        } else if (item.status === "locked") {
          statusClass = "bg-yellow-50 border-yellow-400 shadow-md transform scale-105 z-10";
          if (item.lockedBy === STORE_NAME) {
            btnHtml = `
              <div class="text-[10px] text-yellow-700 font-bold text-center mb-1">æ‚¨é–å®šäº†</div>
              <div class="flex gap-1">
                <button onclick="window.sell(${item.number})" class="flex-1 py-1 bg-red-600 text-white rounded text-xs font-bold">æˆäº¤</button>
                <button onclick="window.unlock(${item.number})" class="flex-1 py-1 bg-gray-400 text-white rounded text-xs font-bold">è§£é™¤</button>
              </div>`;
          } else {
            btnHtml = `<div class="text-[10px] text-yellow-600 font-bold text-center mt-2">é–å®š: ${item.salesName}</div>`;
          }
        } else if (item.status === "sold") {
          statusClass = "bg-red-50 border-red-200 opacity-60";
          btnHtml = `<div class="text-[10px] text-red-400 font-bold text-center mt-2">å”®å‡º: ${item.salesName}</div>`;
        }

        el.className = `${baseClass} ${statusClass}`;
        el.innerHTML = `
          <div class="text-xl font-black text-slate-700 text-center">${item.number}</div>
          <div>${btnHtml}</div>
        `;
        gridEl.appendChild(el);
      });
    }

    // ç›£è½è³‡æ–™åº«
    onSnapshot(collection(db, COLLECTION_NAME), (snap) => {
      snap.forEach(doc => {
        numbers[doc.id] = doc.data();
      });
      render();
    });

    // é–å®šåŠŸèƒ½
    window.lock = async (num) => {
      try {
        await runTransaction(db, async (transaction) => {
          const docRef = doc(db, COLLECTION_NAME, String(num));
          const sfDoc = await transaction.get(docRef);
          if (!sfDoc.exists()) throw "Document does not exist!";
          if (sfDoc.data().status !== "available") throw "è¢«äººæ¶å…ˆäº†ï¼";
          transaction.update(docRef, {
            status: "locked",
            lockedBy: STORE_NAME,
            salesName: STORE_NAME,
            timestamp: new Date()
          });
        });
      } catch (e) { alert(e); }
    };

    // æˆäº¤åŠŸèƒ½
    window.sell = async (num) => {
      if(!confirm(`ç¢ºèªç·¨è™Ÿ ${num} å·²å®Œæˆå®˜ç¶²/é›»è©±è¨‚å–®çµå¸³ï¼Ÿ`)) return;
      await runTransaction(db, async (transaction) => {
        const docRef = doc(db, COLLECTION_NAME, String(num));
        transaction.update(docRef, { status: "sold" });
      });
    };

    // è§£é™¤åŠŸèƒ½
    window.unlock = async (num) => {
      await runTransaction(db, async (transaction) => {
        const docRef = doc(db, COLLECTION_NAME, String(num));
        transaction.update(docRef, {
          status: "available",
          lockedBy: null,
          salesName: null,
          timestamp: null
        });
      });
    };
  </script>
</body>
</html>